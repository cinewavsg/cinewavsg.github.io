<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>River of Dreams</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --brand-teal: #00babf;
            --dark-navy: #1a237e;
            --light-teal: #4dd0e1;
            --white: #ffffff;
        }
        
        body {
            background: linear-gradient(135deg, var(--brand-teal) 0%, var(--light-teal) 40%, var(--dark-navy) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .hero-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 2rem 0;
            padding: 3rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .hero-logo {
            max-width: 300px;
            max-height: 200px;
            width: auto;
            height: auto;
            margin-bottom: 1rem;
            filter: drop-shadow(2px 2px 8px rgba(0,0,0,0.3));
            transition: transform 0.3s ease;
        }
        
        .hero-logo:hover {
            transform: scale(1.05);
        }
        
        .cinewav-logo {
            position: fixed;
            top: 20px;
            left: 20px;
            max-width: 80px;
            max-height: 60px;
            width: auto;
            height: auto;
            z-index: 999;
            filter: drop-shadow(1px 1px 4px rgba(0,0,0,0.3));
            transition: transform 0.3s ease;
        }
        
        .cinewav-logo:hover {
            transform: scale(1.1);
        }
        
        .hero-title {
            color: white;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .hero-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .dream-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin: 2rem 0;
        }
        
        .dream-input {
            border: 2px solid var(--brand-teal);
            border-radius: 50px;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .dream-input:focus {
            border-color: var(--brand-teal);
            box-shadow: 0 0 0 0.25rem rgba(0, 186, 191, 0.25);
        }
        
        .submit-btn {
            background: linear-gradient(45deg, var(--brand-teal), var(--light-teal));
            border: none;
            border-radius: 50px;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .songs-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .section-title {
            color: var(--brand-teal);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .song-tile {
            background: linear-gradient(135deg, rgba(0, 186, 191, 0.15), rgba(77, 208, 225, 0.1));
            border: 2px solid rgba(0, 186, 191, 0.4);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .song-tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 186, 191, 0.2);
            border-color: var(--brand-teal);
        }
        
        .song-tile.latest {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25), rgba(255, 165, 0, 0.15));
            border: 3px solid #FFD700;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            animation: pulse-glow 2s infinite;
        }
        
        .song-tile.latest:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(255, 215, 0, 0.4);
        }
        
        .latest-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
            z-index: 10;
        }
        
        @keyframes pulse-glow {
            0% { box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 8px 35px rgba(255, 215, 0, 0.5); }
            100% { box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3); }
        }
        
        .song-timestamp {
            color: var(--brand-teal);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .song-preview {
            color: var(--brand-teal);
            font-size: 1rem;
            margin-top: 0.5rem;
            line-height: 1.6;
            font-weight: 500;
        }
        
        .admin-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .admin-form textarea {
            border: 2px solid var(--brand-teal);
            border-radius: 10px;
            min-height: 200px;
        }
        
        .admin-form textarea:focus {
            border-color: var(--brand-teal);
            box-shadow: 0 0 0 0.25rem rgba(0, 186, 191, 0.25);
        }
        
        .page-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toggle-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
        }
        
        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
            color: white;
        }
        
        .modal-content {
            border-radius: 20px;
            border: none;
        }
        .site-logo {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 80px;
            max-height: 60px;
            width: auto;
            height: auto;
            z-index: 999;
            filter: drop-shadow(1px 1px 4px rgba(0,0,0,0.3));
            transition: transform 0.3s ease;
        }
        
        .site-logo:hover {
            transform: scale(1.1);
        }
        
        .page-toggle {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 1000;
        }
        .modal-header {
            background: linear-gradient(45deg, var(--brand-teal), var(--light-teal));
            color: white;
            border-radius: 20px 20px 0 0;
        }
        
        .lyrics-display {
            background: rgba(0, 186, 191, 0.05);
            padding: 2rem;
            border-radius: 10px;
            border-left: 4px solid var(--brand-teal);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.1rem;
            font-weight: 500;
            line-height: 1.8;
            white-space: pre-line;
            color: #333;
        }
        
        .loading {
            text-align: center;
            color: var(--brand-teal);
            padding: 2rem;
        }
        
        .spinner-border {
            color: var(--brand-teal);
        }
        
        .success-message {
            background: rgba(0, 186, 191, 0.15);
            border: 2px solid rgba(0, 186, 191, 0.5);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            color: var(--brand-teal);
            font-weight: 600;
            text-align: center;
        }
        
        .hidden-iframe {
            display: none;
        }
        
        /* Logo fallback and error handling */
        .logo-fallback {
            color: white;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: none;
        }
        
        .logo-fallback.show {
            display: block;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .hero-section {
                padding: 2rem 1rem;
                margin: 1rem 0;
            }
            
            .hero-logo {
                max-width: 250px;
                max-height: 150px;
                transform: none !important;
            }
            
            .hero-logo:hover {
                transform: none !important;
            }
            
            .cinewav-logo {
                max-width: 60px;
                max-height: 45px;
                top: 15px;
                left: 15px;
                transform: none !important;
            }
            
            .cinewav-logo:hover {
                transform: none !important;
            }
            
            .hero-title {
                font-size: 2rem;
            }
            
            .hero-subtitle {
                font-size: 1rem;
                padding: 0 1rem;
            }
            
            .section-title {
                font-size: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .submit-btn {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
                letter-spacing: 0.5px;
            }
            
            .toggle-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .dream-form {
                padding: 1.5rem;
                margin: 1rem 0;
            }
            
            .dream-input {
                padding: 0.8rem 1rem;
                font-size: 1rem;
                margin-bottom: 1rem;
            }
            
            .songs-section {
                padding: 1.5rem;
                margin: 1rem 0;
            }
            
            .admin-panel {
                padding: 1.5rem;
                margin: 1rem 0;
            }
            
            .song-tile {
                padding: 1rem;
                margin: 0.5rem 0;
            }
            
            .lyrics-display {
                padding: 1.5rem;
                font-size: 1rem;
                line-height: 1.6;
            }
            
            .modal-content {
                margin: 1rem;
            }
            
            .modal-body .lyrics-display {
                padding: 1rem;
                font-size: 0.95rem;
            }
            
            .row .col-md-9,
            .row .col-md-3 {
                margin-bottom: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .hero-logo {
                max-width: 200px;
                max-height: 120px;
            }
            
            .cinewav-logo {
                max-width: 50px;
                max-height: 38px;
                top: 10px;
                left: 10px;
            }
            
            .hero-title {
                font-size: 1.8rem;
            }
            
            .section-title {
                font-size: 1.3rem;
            }
            
            .submit-btn {
                padding: 0.7rem 1.2rem;
                font-size: 0.85rem;
            }
            
            .toggle-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .page-toggle {
                top: 15px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Hidden iframes for form submissions -->
    <iframe name="dream-frame" class="hidden-iframe"></iframe>
    <iframe name="lyrics-frame" class="hidden-iframe"></iframe>
    
    <!-- CineWav Logo (optional - if you have the logo file) -->
    <!-- <img src="Cinewav.png" alt="CineWav" class="cinewav-logo" onerror="this.style.display='none'"> -->
    
    

    <!-- User Page -->
    <div id="user-page" class="container-fluid">
        <div class="container">
            <!-- Site Logo (top right) -->
<img src="Logo.png" alt="Site Logo" class="site-logo" onerror="this.style.display='none'">

<!-- CineWav Logo (top left) -->
<img src="Cinewav.png" alt="CineWav" class="cinewav-logo" onerror="this.style.display='none'">
            <!-- Hero Section -->
            <div class="hero-section">
                <!-- Logo Image -->
                <img src="riverdreams.png" 
                     alt="River Dreams Logo" 
                     class="hero-logo" 
                     id="hero-logo"
                     onerror="handleLogoError()">
                
                <!-- Fallback title (hidden by default) -->
                <h1 class="logo-fallback" id="logo-fallback">
                    <i class="fas fa-water"></i>
                    River of Dreams
                </h1>
                
                <p class="hero-subtitle">
                    <b>We invite you to share your dreams for the Singapore River - what do you hope for? What do you wish to see? Your collective dreams will become part of tonight's show!</b>
                </p>
            </div>

            <!-- Dream Submission Form -->
            <div class="dream-form">
                <h3 class="text-center mb-4" style="color: var(--brand-teal);">
                     Share Your Dream For The Singapore River 
                </h3>
                
                <!-- Dream form connected to Google Forms -->
                <form action="https://docs.google.com/forms/d/e/1FAIpQLSeqX84QCR3RC6sJRqIXszVthEK-dAkF18EpfJcn6gJB0R_SXw/formResponse" 
                      method="POST" 
                      target="dream-frame" 
                      onsubmit="submitDream(event)">
                    <div class="row">
                        <div class="col-md-9">
                            <input type="text" 
                                   class="form-control dream-input" 
                                   name="entry.688882351"
                                   id="dream-input" 
                                   placeholder="Type here..."
                                   required
                                   maxlength="500">
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn submit-btn w-100">
                                <i class="fas fa-paper-plane"></i>
                                Submit Dream
                            </button>
                        </div>
                    </div>
                </form>
                
                <div id="dream-success" class="success-message" style="display: none;">
                    <i class="fas fa-check-circle"></i> Your dream has been submitted! Go back one page or swipe down to get ready for the show!
                </div>
            </div>

            <!-- Songs History Section -->
            <div class="songs-section">
                <h2 class="section-title">
                    <i class="fas fa-music"></i>
                    Musical Masterpieces
                </h2>
                <p class="text-center text-muted mb-4">
                    Dreams transformed into beautiful lyrics, inspired by the Singapore River
                </p>
                
                <div id="songs-loading" class="loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading musical masterpieces...</p>
                </div>
                
                <div id="songs-container">
                    <!-- Songs will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="admin-page" class="container-fluid" style="display: none;">
        <div class="container">
            <div class="hero-section">
                <h1 class="hero-title">
                    <i class="fas fa-user-shield"></i>
                    Admin Panel
                </h1>
                <p class="hero-subtitle">
                    Transform dreams into musical lyrics
                </p>
            </div>

            <!-- AI Song Generator -->
            <div class="admin-panel">
                <h3 class="text-center mb-4" style="color: var(--brand-teal);">
                    <i class="fas fa-robot"></i> AI Song Generator
                </h3>
                
                <!-- API Configuration -->
                <div class="mb-4">
                    <h5 style="color: var(--brand-teal);"><i class="fas fa-key"></i> API Configuration</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="claude-api-key" class="form-label fw-bold">Claude API Key</label>
                            <input type="password" 
                                   class="form-control" 
                                   id="claude-api-key" 
                                   placeholder="Enter your Anthropic Claude API key..."
                                   style="border: 2px solid var(--brand-teal);">
                        </div>
                        <div class="col-md-6">
                            <label for="suno-api-key" class="form-label fw-bold">Suno API Key</label>
                            <input type="password" 
                                   class="form-control" 
                                   id="suno-api-key" 
                                   placeholder="Enter your Suno API key..."
                                   style="border: 2px solid var(--brand-teal);">
                        </div>
                    </div>
                </div>

                <!-- Song Configuration -->
                <div class="mb-4">
                    <h5 style="color: var(--brand-teal);"><i class="fas fa-cog"></i> Song Configuration</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <label for="song-title" class="form-label fw-bold">Song Title</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="song-title" 
                                   value="Singapore River Dreams"
                                   style="border: 2px solid var(--brand-teal);">
                        </div>
                        <div class="col-md-4">
                            <label for="genre-select" class="form-label fw-bold">Genre</label>
                            <select class="form-control" id="genre-select" style="border: 2px solid var(--brand-teal);">
                                <option value="Pop">Pop</option>
                                <option value="Folk">Folk</option>
                                <option value="Indie">Indie</option>
                                <option value="Acoustic">Acoustic</option>
                                <option value="Classical">Classical</option>
                                <option value="Electronic">Electronic</option>
                                <option value="Rock">Rock</option>
                                <option value="Jazz">Jazz</option>
                                <option value="R&B">R&B</option>
                                <option value="Country">Country</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="vocal-type" class="form-label fw-bold">Vocal Type</label>
                            <select class="form-control" id="vocal-type" style="border: 2px solid var(--brand-teal);">
                                <option value="Mixed">Mixed</option>
                                <option value="Male Singer">Male Singer</option>
                                <option value="Female Singer">Female Singer</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="additional-style" class="form-label fw-bold">Additional Style</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="additional-style" 
                                   placeholder="e.g., Uplifting, Dreamy, Inspirational"
                                   style="border: 2px solid var(--brand-teal);">
                        </div>
                        <div class="col-md-6">
                            <label for="negative-tags" class="form-label fw-bold">Styles to Avoid</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="negative-tags" 
                                   value="Heavy Metal, Aggressive, Dark"
                                   style="border: 2px solid var(--brand-teal);">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-check-label fw-bold">
                            <input type="checkbox" class="form-check-input" id="instrumental-only"> 
                            Instrumental Only
                        </label>
                    </div>
                </div>

                <!-- Generation Controls -->
                <div class="text-center mb-4">
                    <button class="btn submit-btn me-3" onclick="loadDreamsAndGenerateLyrics()">
                        <i class="fas fa-brain"></i>
                        Generate Lyrics from Dreams
                    </button>
                    <button class="btn submit-btn" onclick="generateSunoSong()" disabled id="generate-song-btn">
                        <i class="fas fa-music"></i>
                        Create Song with Suno
                    </button>
                </div>

                <!-- Status Display -->
                <div id="generation-status" style="display: none;">
                    <div class="loading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <p id="status-text">Processing...</p>
                    </div>
                </div>

                <!-- Generated Lyrics Display -->
                <div id="generated-lyrics-display" style="display: none;">
                    <h5 style="color: var(--brand-teal);"><i class="fas fa-scroll"></i> Generated Lyrics</h5>
                    <div class="lyrics-display" id="lyrics-preview"></div>
                    <div class="text-center mt-3">
                        <button class="btn submit-btn" onclick="publishGeneratedLyrics()">
                            <i class="fas fa-upload"></i>
                            Publish to User Portal
                        </button>
                    </div>
                </div>

                <!-- Suno Song Status -->
                <div id="suno-status-display" style="display: none;">
                    <h5 style="color: var(--brand-teal);"><i class="fas fa-headphones"></i> Song Generation Status</h5>
                    <div id="suno-details"></div>
                </div>
            </div>

            <!-- Manual Lyrics Entry (Original Form) -->
            <div class="admin-panel">
                <h3 class="text-center mb-4" style="color: var(--brand-teal);">
                    <i class="fas fa-feather-alt"></i> Manual Lyrics Entry
                </h3>
                
                <!-- Lyrics form connected to Google Forms -->
                <form action="https://docs.google.com/forms/d/e/1FAIpQLSfsuosncboXU-pnO8990J3u7kvyCSZ3nO6756x180qB7nDvcQ/formResponse" 
                      method="POST" 
                      target="lyrics-frame" 
                      class="admin-form" 
                      onsubmit="submitLyrics(event)">
                    <div class="mb-3">
                        <label for="lyrics-title" class="form-label fw-bold">Song Title</label>
                        <input type="text" 
                               class="form-control" 
                               name="entry.1504498847"
                               id="lyrics-title" 
                               placeholder="Enter song title..."
                               required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="lyrics-content" class="form-label fw-bold">Lyrics Content</label>
                        <textarea class="form-control" 
                                  name="entry.1018977358"
                                  id="lyrics-content" 
                                  rows="12" 
                                  placeholder="Enter the complete lyrics here..."
                                  required></textarea>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn submit-btn">
                            <i class="fas fa-music"></i>
                            Publish Lyrics
                        </button>
                    </div>
                </form>
                
                <div id="lyrics-success" class="success-message" style="display: none;">
                    <i class="fas fa-check-circle"></i> Lyrics published successfully!
                </div>
            </div>

            <!-- Recent Dreams for Admin Reference -->
            <div class="admin-panel">
                <h3 class="text-center mb-4" style="color: var(--brand-teal);">
                    <i class="fas fa-eye"></i> Recent Dreams Submitted
                </h3>
                
                <div id="dreams-loading" class="loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading recent dreams...</p>
                </div>
                
                <div id="recent-dreams">
                    <!-- Recent dreams will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Song Modal -->
    <div class="modal fade" id="songModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-music"></i>
                        <span id="modal-song-title">Song Title</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="lyrics-display" id="modal-lyrics-content">
                        <!-- Lyrics content will be displayed here -->
                    </div>
                    <p class="text-muted mt-3">
                        <i class="fas fa-clock"></i>
                        Published: <span id="modal-song-timestamp"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configuration - updated with new spreadsheets and API key
        const CONFIG = {
            DREAMS_SHEET_ID: '1CRmG9M841oGGJjT8ks4b-2zR0vrFy0tHCMf_099Zxf0',
            LYRICS_SHEET_ID: '1OlONdpD0lG0CWYGPVHkGOYzAnvJqzFrAzzhUqpER_fU',
            API_KEY: 'AIzaSyDZJStLtzPmKODr03qzGNUUCrAFx3deHXM',
            DREAMS_RANGE: 'Form Responses 2!A:B',
            LYRICS_RANGE: 'Form Responses 1!A:C'
        };
        // Handle logo loading error
        function handleLogoError() {
            console.log('Logo failed to load, showing fallback text');
            document.getElementById('hero-logo').style.display = 'none';
            document.getElementById('logo-fallback').classList.add('show');
        }
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadSongs();
            loadRecentDreams();
        });
        // FIXED: Parse date in DD/MM/YYYY HH:MM:SS format
        function parseDate(dateString) {
            if (!dateString || dateString === 'Timestamp' || dateString === '') {
                return new Date(0);
            }
            
            // Clean and trim the input
            let cleanDateString = dateString.toString().trim();
            
            // First try: Direct parsing (for standard formats)
            let date = new Date(cleanDateString);
            if (!isNaN(date.getTime()) && cleanDateString !== cleanDateString.match(/^\d/)) {
                return date;
            }
            
            // Handle DD/MM/YYYY HH:MM:SS format specifically
            const dateTimeRegex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
            const match = cleanDateString.match(dateTimeRegex);
            
            if (match) {
                const [, day, month, year, hour, minute, second] = match;
                
                // Create date (month is 0-indexed in JavaScript)
                const parsedDate = new Date(
                    parseInt(year), 
                    parseInt(month) - 1, 
                    parseInt(day), 
                    parseInt(hour), 
                    parseInt(minute), 
                    parseInt(second)
                );
                
                // Validate the created date
                if (!isNaN(parsedDate.getTime())) {
                    return parsedDate;
                }
            }
            
            // Handle potential concatenated timestamps (take the first one)
            const firstTimestampMatch = cleanDateString.match(/^(\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{1,2}:\d{1,2})/);
            if (firstTimestampMatch) {
                return parseDate(firstTimestampMatch[1]);
            }
            
            // Last resort: try to parse as standard date format
            try {
                const fallbackDate = new Date(cleanDateString);
                if (!isNaN(fallbackDate.getTime())) {
                    return fallbackDate;
                }
            } catch (e) {
                console.warn('Failed to parse date:', cleanDateString, e);
            }
            
            // Return epoch if all parsing attempts fail
            console.warn('Could not parse date string:', cleanDateString);
            return new Date(0);
        }
        // FIXED: Format timestamp for display with better error handling
        function formatTimestamp(timestamp) {
            if (!timestamp) {
                return 'No timestamp';
            }
            
            const date = parseDate(timestamp);
            
            // Check if date is valid
            if (isNaN(date.getTime()) || date.getTime() === 0) {
                return 'Invalid Date';
            }
            
            try {
                const dateStr = date.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                const timeStr = date.toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                return `${dateStr} at ${timeStr}`;
            } catch (e) {
                console.warn('Error formatting timestamp:', timestamp, e);
                return 'Format Error';
            }
        }
        // Toggle between user and admin pages
        function togglePage() {
            const userPage = document.getElementById('user-page');
            const adminPage = document.getElementById('admin-page');
            const toggleText = document.getElementById('toggle-text');
            
            if (userPage.style.display === 'none') {
                userPage.style.display = 'block';
                adminPage.style.display = 'none';
                toggleText.textContent = 'Admin';
                loadSongs();
            } else {
                userPage.style.display = 'none';
                adminPage.style.display = 'block';
                toggleText.textContent = 'User';
                loadRecentDreams();
            }
        }
        // Submit dream (now using Google Forms)
        function submitDream(event) {
            const dreamInput = document.getElementById('dream-input');
            const dream = dreamInput.value.trim();
            
            // Check if dream is empty
            if (!dream) {
                event.preventDefault();
                alert('Please enter your dream before submitting!');
                return false;
            }
            
            // Show success message after a short delay to allow form submission
            setTimeout(() => {
                document.getElementById('dream-success').style.display = 'block';
                dreamInput.value = '';
                
                // Hide success message after 5 seconds
                setTimeout(() => {
                    document.getElementById('dream-success').style.display = 'none';
                }, 5000);
            }, 500);
            
            // Allow the form to submit to Google Forms
            return true;
        }
        // Submit lyrics (now using Google Forms)
        function submitLyrics(event) {
            const titleInput = document.getElementById('lyrics-title');
            const lyricsInput = document.getElementById('lyrics-content');
            const title = titleInput.value.trim();
            const lyrics = lyricsInput.value.trim();
            
            // Check if both fields are filled
            if (!title || !lyrics) {
                event.preventDefault();
                alert('Please fill in both the song title and lyrics content!');
                return false;
            }
            
            // Show success message after a short delay to allow form submission
            setTimeout(() => {
                document.getElementById('lyrics-success').style.display = 'block';
                titleInput.value = '';
                lyricsInput.value = '';
                
                // Hide success message after 3 seconds
                setTimeout(() => {
                    document.getElementById('lyrics-success').style.display = 'none';
                }, 3000);
            }, 500);
            
            // Allow the form to submit to Google Forms
            return true;
        }
        async function loadSongs() {
            const container = document.getElementById('songs-container');
            const loading = document.getElementById('songs-loading');
            
            try {
                loading.style.display = 'block';
                container.innerHTML = '';
                
                const songs = await fetchSongsFromSheet();
                
                loading.style.display = 'none';
                
                if (songs.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-music fa-3x mb-3"></i>
                            <p>No musical masterpieces yet. Dreams are waiting to be transformed into songs!</p>
                        </div>
                    `;
                    return;
                }
                
                songs.forEach((song, index) => {
                    const songTile = createSongTile(song, index);
                    container.appendChild(songTile);
                });
                
            } catch (error) {
                loading.style.display = 'none';
                console.error('Error loading songs:', error);
                container.innerHTML = `
                    <div class="text-center text-danger py-5">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Error loading songs. Please check your API configuration.</p>
                        <small>Make sure your Google Sheets are public and API key is valid.</small>
                    </div>
                `;
            }
        }
        async function fetchSongsFromSheet() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.LYRICS_SHEET_ID}/values/${CONFIG.LYRICS_RANGE}?key=${CONFIG.API_KEY}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const values = data.values || [];
            
            console.log('Raw sheet data:', values); // Debug log
            
            const songs = values
                .slice(1) // Skip header row
                .filter(row => row.length >= 3) // Ensure we have all columns
                .filter(row => row[0] && row[0] !== 'Timestamp') // Extra safety check
                .map(row => {
                    const song = {
                        timestamp: row[0], // Keep original string
                        parsedDate: parseDate(row[0]), // Store parsed date separately
                        title: row[1] || 'Untitled',
                        lyrics: row[2] || 'No lyrics available'
                    };
                    console.log('Parsed song:', song); // Debug log
                    return song;
                })
                .sort((a, b) => b.parsedDate - a.parsedDate);
            
            return songs;
        }
        function createSongTile(song, index) {
            const tile = document.createElement('div');
            tile.className = index === 0 ? 'song-tile latest' : 'song-tile';
            tile.onclick = () => showSongModal(song);
            
            const preview = song.lyrics.substring(0, 100) + (song.lyrics.length > 100 ? '...' : '');
            
            const latestBadge = index === 0 ? '<div class="latest-badge"><i class="fas fa-star"></i> Latest</div>' : '';
            
            tile.innerHTML = `
                ${latestBadge}
                <div class="song-timestamp">
                    <i class="fas fa-clock"></i>
                    ${formatTimestamp(song.timestamp)}
                </div>
                <h5 style="color: var(--brand-teal); margin: 0.5rem 0;">
                    <i class="fas fa-music"></i>
                    ${song.title}
                    ${index === 0 ? ' <i class="fas fa-fire" style="color: #FF6B35; margin-left: 0.5rem;" title="Latest Release!"></i>' : ''}
                </h5>
                <div class="song-preview">
                    ${preview}
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-mouse-pointer"></i>
                        Click to view full lyrics
                    </small>
                </div>
            `;
            
            return tile;
        }
        function showSongModal(song) {
            document.getElementById('modal-song-title').textContent = song.title;
            document.getElementById('modal-lyrics-content').textContent = song.lyrics;
            document.getElementById('modal-song-timestamp').textContent = formatTimestamp(song.timestamp);
            
            const modal = new bootstrap.Modal(document.getElementById('songModal'));
            modal.show();
        }
        async function loadRecentDreams() {
            const container = document.getElementById('recent-dreams');
            const loading = document.getElementById('dreams-loading');
            
            try {
                loading.style.display = 'block';
                container.innerHTML = '';
                
                const dreams = await fetchDreamsFromSheet();
                
                loading.style.display = 'none';
                
                if (dreams.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-cloud fa-3x mb-3"></i>
                            <p>No dreams submitted yet.</p>
                        </div>
                    `;
                    return;
                }
                
                dreams.forEach(dream => {
                    const dreamTile = createDreamTile(dream);
                    container.appendChild(dreamTile);
                });
                
            } catch (error) {
                loading.style.display = 'none';
                console.error('Error loading dreams:', error);
                container.innerHTML = `
                    <div class="text-center text-danger py-5">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Error loading dreams. Please check your API configuration.</p>
                        <small>Make sure your Google Sheets are public and API key is valid.</small>
                    </div>
                `;
            }
        }
        async function fetchDreamsFromSheet() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.DREAMS_SHEET_ID}/values/${CONFIG.DREAMS_RANGE}?key=${CONFIG.API_KEY}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const values = data.values || [];
            
            console.log('Raw dreams data:', values); // Debug log
            
            const dreams = values
                .slice(1) // Skip header row
                .filter(row => row.length >= 2) // Ensure we have both columns
                .filter(row => row[0] && row[0] !== 'Timestamp') // Extra safety check
                .map(row => {
                    const dream = {
                        timestamp: row[0], // Keep original string
                        parsedDate: parseDate(row[0]), // Store parsed date separately
                        dream: row[1] || 'No dream content'
                    };
                    console.log('Parsed dream:', dream); // Debug log
                    return dream;
                })
                .sort((a, b) => b.parsedDate - a.parsedDate)
                .slice(0, 20); // Show latest 20 dreams
            
            return dreams;
        }
        function createDreamTile(dream) {
            const tile = document.createElement('div');
            tile.className = 'song-tile mb-3';
            
            tile.innerHTML = `
                <div class="song-timestamp">
                    <i class="fas fa-clock"></i>
                    ${formatTimestamp(dream.timestamp)}
                </div>
                <div class="song-preview">
                    <i class="fas fa-quote-left"></i>
                    ${dream.dream}
                    <i class="fas fa-quote-right"></i>
                </div>
            `;
            
            return tile;
        }
        // Global variables for AI generation
        let generatedLyrics = '';
        let currentTaskId = '';
        // Load dreams and generate lyrics
        async function loadDreamsAndGenerateLyrics() {
            const claudeApiKey = document.getElementById('claude-api-key').value.trim();
            
            const statusDiv = document.getElementById('generation-status');
            const statusText = document.getElementById('status-text');
            
            try {
                // Show loading
                statusDiv.style.display = 'block';
                statusText.textContent = 'Loading latest 50 dreams from spreadsheet...';
                
                // Fetch dreams from the sheet
                const dreams = await fetchLatestDreams(50);
                
                if (dreams.length === 0) {
                    throw new Error('No dreams found in the spreadsheet');
                }
                
                statusText.textContent = `Found ${dreams.length} dreams. Generating lyrics...`;
                
                let lyrics;
                if (claudeApiKey) {
                    statusText.textContent = `Found ${dreams.length} dreams. Generating lyrics with AI...`;
                    lyrics = await generateLyricsWithClaude(dreams, claudeApiKey);
                } else {
                    statusText.textContent = `Found ${dreams.length} dreams. Generating lyrics with template system...`;
                    lyrics = await generateLyricsAlternative(dreams);
                }
                
                if (lyrics) {
                    generatedLyrics = lyrics;
                    statusDiv.style.display = 'none';
                    
                    // Display generated lyrics
                    const lyricsDisplay = document.getElementById('generated-lyrics-display');
                    const lyricsPreview = document.getElementById('lyrics-preview');
                    
                    lyricsPreview.textContent = lyrics;
                    lyricsDisplay.style.display = 'block';
                    
                    // Enable song generation button
                    document.getElementById('generate-song-btn').disabled = false;
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success-message';
                    successDiv.innerHTML = claudeApiKey ? 
                        '<i class="fas fa-check-circle"></i> Lyrics generated successfully with AI!' :
                        '<i class="fas fa-check-circle"></i> Lyrics generated successfully with template system! (Add Claude API key for AI generation)';
                    lyricsDisplay.insertBefore(successDiv, lyricsDisplay.firstChild);
                    
                    setTimeout(() => successDiv.remove(), 5000);
                } else {
                    throw new Error('Failed to generate lyrics');
                }
                
            } catch (error) {
                statusDiv.style.display = 'none';
                console.error('Error in generation process:', error);
                alert(`Error: ${error.message}`);
            }
        }
        // Fetch latest dreams from spreadsheet
        async function fetchLatestDreams(limit = 50) {
            try {
                const dreams = await fetchDreamsFromSheet();
                return dreams.slice(0, limit).map(dream => dream.dream);
            } catch (error) {
                console.error('Error fetching dreams:', error);
                throw new Error('Failed to load dreams from spreadsheet');
            }
        }
        // Generate lyrics using Claude API with CORS proxy
        async function generateLyricsWithClaude(dreams, apiKey) {
            const dreamsText = dreams.map((dream, index) => `- ${dream}`).join('\n');
            
            const prompt = `Create 2-minute song lyrics that incorporates the following dreams about Singapore River, subtracting any hate or inappropriate content:
${dreamsText}
Make the lyrics inspiring, cohesive, and celebratory of Singapore's river. Structure it with verses and chorus. Focus on themes of hope, community, nature, and the future of Singapore's waterways.`;
            // Using a CORS proxy service
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const targetUrl = 'https://api.anthropic.com/v1/messages';
            
            const headers = {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01',
                'X-Requested-With': 'XMLHttpRequest'
            };
            
            const data = {
                'model': 'claude-3-5-sonnet-20241022',
                'max_tokens': 800,
                'messages': [
                    {
                        'role': 'user',
                        'content': prompt
                    }
                ]
            };
            
            try {
                // First try with cors-anywhere
                const response = await fetch(proxyUrl + targetUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.content[0].text;
                } else {
                    // If cors-anywhere fails, try alternative method
                    throw new Error('CORS proxy failed, trying alternative...');
                }
                
            } catch (error) {
                console.error('CORS Proxy Method Failed:', error);
                
                // Alternative: Use a different approach
                return await generateLyricsAlternative(dreams);
            }
        }
        // Alternative lyrics generation using a fallback method
        async function generateLyricsAlternative(dreams) {
            // Since we can't directly call Claude API from browser, we'll create 
            // a simple template-based lyrics generator as fallback
            
            const themes = [
                "flowing waters", "city lights", "dreams come true", "nature's beauty",
                "community spirit", "bright future", "peaceful moments", "Singapore's heart"
            ];
            
            const verseTemplates = [
                "Along the river where dreams take flight,\nWhere {theme1} meets the {theme2},\nWe gather here with hopes so bright,\nFor Singapore's future, pure and free.",
                "The water flows with stories old,\nOf {theme1} and {theme2} we hold,\nEach dream a treasure, each wish like gold,\nIn Singapore's river, bold and free.",
                "Beneath the stars and city glow,\nWhere {theme1} and {theme2} grow,\nOur dreams unite in gentle flow,\nAlong Singapore's river, wild and free."
            ];
            
            const chorus = `Singapore River, carry our dreams,\nFlow through the city with hopeful streams,\nUnite our hearts, fulfill our schemes,\nSingapore River, where future gleams.`;
            
            // Select random themes and templates
            const selectedThemes = themes.sort(() => 0.5 - Math.random()).slice(0, 4);
            const selectedTemplates = verseTemplates.sort(() => 0.5 - Math.random()).slice(0, 2);
            
            // Build the song
            let lyrics = `**Singapore River Dreams**\n\n`;
            
            // Verse 1
            lyrics += `**Verse 1:**\n`;
            lyrics += selectedTemplates[0]
                .replace('{theme1}', selectedThemes[0])
                .replace('{theme2}', selectedThemes[1]);
            lyrics += `\n\n`;
            
            // Chorus
            lyrics += `**Chorus:**\n${chorus}\n\n`;
            
            // Verse 2
            lyrics += `**Verse 2:**\n`;
            lyrics += selectedTemplates[1]
                .replace('{theme1}', selectedThemes[2])
                .replace('{theme2}', selectedThemes[3]);
            lyrics += `\n\n`;
            
            // Chorus again
            lyrics += `**Chorus:**\n${chorus}\n\n`;
            
            // Bridge (incorporating actual dream content)
            lyrics += `**Bridge:**\n`;
            const dreamSample = dreams.slice(0, 3);
            lyrics += `We dream of ${dreamSample.join(', and ')},\n`;
            lyrics += `All flowing together like the river's song,\n`;
            lyrics += `Singapore's future, forever strong.\n\n`;
            
            // Final Chorus
            lyrics += `**Final Chorus:**\n${chorus}`;
            
            return lyrics;
        }
        // Generate song with Suno API
        async function generateSunoSong() {
            const sunoApiKey = document.getElementById('suno-api-key').value.trim();
            
            if (!sunoApiKey) {
                alert('Please enter your Suno API key first!');
                return;
            }
            
            if (!generatedLyrics) {
                alert('Please generate lyrics first!');
                return;
            }
            const statusDiv = document.getElementById('generation-status');
            const statusText = document.getElementById('status-text');
            
            try {
                statusDiv.style.display = 'block';
                statusText.textContent = 'Sending request to Suno API for song generation...';
                
                // Get configuration values
                const config = {
                    title: document.getElementById('song-title').value || 'Singapore River Dreams',
                    genre: document.getElementById('genre-select').value,
                    vocalType: document.getElementById('vocal-type').value,
                    additionalStyle: document.getElementById('additional-style').value,
                    negativeTags: document.getElementById('negative-tags').value,
                    instrumental: document.getElementById('instrumental-only').checked
                };
                
                const result = await callSunoAPI(generatedLyrics, config, sunoApiKey);
                
                statusDiv.style.display = 'none';
                
                if (result && result.data) {
                    const taskId = result.data.task_id || 'unknown';
                    const isMock = result.data.mock || false;
                    currentTaskId = taskId;
                    
                    // Display Suno status
                    const sunoStatusDiv = document.getElementById('suno-status-display');
                    const sunoDetails = document.getElementById('suno-details');
                    
                    const statusBadge = isMock ? 
                        '<span class="badge bg-warning">Demo Mode (CORS Issue)</span>' : 
                        '<span class="badge bg-success">Processing</span>';
                    
                    const messageText = isMock ? 
                        'Demo response created due to CORS restrictions. In production, use a backend server to avoid CORS issues.' :
                        'Song generation request sent successfully!';
                    
                    const linkText = isMock ? 
                        'Check Suno API Logs (Use your real API key)' :
                        'Check Song Status';
                    
                    sunoDetails.innerHTML = `
                        <div class="success-message">
                            <i class="fas fa-check-circle"></i> ${messageText}
                        </div>
                        <div class="preview-box">
                            <h6><i class="fas fa-id-card"></i> Task ID: <code>${taskId}</code></h6>
                            <p><strong>Song Title:</strong> ${config.title}</p>
                            <p><strong>Genre:</strong> ${config.genre}</p>
                            <p><strong>Status:</strong> ${statusBadge}</p>
                            ${isMock ? `
                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Note:</strong> This is a demo response due to CORS restrictions. 
                                    Your actual API request may have been sent successfully. 
                                    Check the Suno API logs with your real API key to see the actual status.
                                </div>
                            ` : ''}
                            <div class="mt-3">
                                <a href="https://sunoapi.org/logs" target="_blank" class="link-button">
                                    <i class="fas fa-external-link-alt"></i> ${linkText}
                                </a>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Song generation typically takes 2-5 minutes. ${isMock ? 'Check logs with your real task ID.' : 'Use the Task ID above to find your song.'}
                                </small>
                            </div>
                        </div>
                    `;
                    
                    sunoStatusDiv.style.display = 'block';
                    
                    // If it's a mock response, also show how to resolve CORS
                    if (isMock) {
                        const corsHelp = document.createElement('div');
                        corsHelp.className = 'preview-box mt-3';
                        corsHelp.innerHTML = `
                            <h6><i class="fas fa-wrench"></i> How to Fix CORS Issues:</h6>
                            <ul style="text-align: left;">
                                <li><strong>Option 1:</strong> Deploy a simple backend server to proxy API calls</li>
                                <li><strong>Option 2:</strong> Use browser extensions that disable CORS (for testing only)</li>
                                <li><strong>Option 3:</strong> Check if your Suno API request actually went through in the logs</li>
                            </ul>
                        `;
                        sunoDetails.appendChild(corsHelp);
                    }
                } else {
                    throw new Error('Invalid response format from Suno API');
                }
                
            } catch (error) {
                statusDiv.style.display = 'none';
                console.error('Suno API Error:', error);
                
                // Show a more helpful error message
                const errorMsg = `Song generation encountered an issue: ${error.message}\n\nThis might be due to CORS restrictions. Your API request may have still been sent successfully. Please check the Suno API logs to verify.`;
                alert(errorMsg);
            }
        }
        // Call Suno API with CORS proxy
        async function callSunoAPI(lyrics, config, apiKey) {
            const sunoUrl = "https://apibox.erweima.ai/api/v1/generate";
            
            // Build style string
            const styleParts = [config.genre];
            if (config.vocalType !== "Mixed") {
                styleParts.push(config.vocalType);
            }
            if (config.additionalStyle) {
                styleParts.push(config.additionalStyle);
            }
            
            const data = {
                'prompt': config.instrumental ? `Instrumental track based on Singapore River dreams` : lyrics,
                'style': styleParts.join(', '),
                'title': config.title,
                'customMode': true,
                'instrumental': config.instrumental,
                'model': 'V4_5',
                'negativeTags': config.negativeTags,
                'callBackUrl': 'https://api.example.com/callback'
            };
            
            // Try multiple approaches for CORS handling
            const corsProxies = [
                'https://cors-anywhere.herokuapp.com/',
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?'
            ];
            
            for (let i = 0; i < corsProxies.length; i++) {
                try {
                    const proxyUrl = corsProxies[i];
                    const fullUrl = proxyUrl + encodeURIComponent(sunoUrl);
                    
                    const headers = {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    };
                    
                    // Add special headers for certain proxies
                    if (proxyUrl.includes('cors-anywhere')) {
                        headers['X-Requested-With'] = 'XMLHttpRequest';
                    }
                    
                    const response = await fetch(fullUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Suno API Response:', result);
                        
                        if (result && (result.code === 200 || result.data || result.task_id)) {
                            return result;
                        } else {
                            console.warn(`Proxy ${i + 1} returned unexpected format:`, result);
                            continue;
                        }
                    } else {
                        console.warn(`Proxy ${i + 1} failed with status:`, response.status);
                        continue;
                    }
                    
                } catch (error) {
                    console.warn(`Proxy ${i + 1} failed:`, error);
                    continue;
                }
            }
            
            // If all proxies fail, try direct call (might work in some environments)
            try {
                console.log('Trying direct API call...');
                const response = await fetch(sunoUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result;
                }
            } catch (error) {
                console.warn('Direct call also failed:', error);
            }
            
            // If everything fails, simulate a successful response for demo purposes
            console.log('All API calls failed, creating mock response...');
            return createMockSunoResponse(config);
        }
        // Create mock response when API calls fail
        function createMockSunoResponse(config) {
            const mockTaskId = 'mock_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            return {
                code: 200,
                msg: "Success (Mock Response - CORS Issue)",
                data: {
                    task_id: mockTaskId,
                    status: "submitted",
                    title: config.title,
                    style: config.genre,
                    mock: true
                }
            };
        }
        // Publish generated lyrics to user portal
        async function publishGeneratedLyrics() {
            if (!generatedLyrics) {
                alert('No lyrics to publish!');
                return;
            }
            
            const songTitle = document.getElementById('song-title').value || 'AI Generated Song';
            
            try {
                // Create form data for Google Forms submission
                const formData = new FormData();
                formData.append('entry.1504498847', songTitle); // Title field
                formData.append('entry.1018977358', generatedLyrics); // Lyrics field
                
                // Submit to Google Forms
                const response = await fetch('https://docs.google.com/forms/d/e/1FAIpQLSfsuosncboXU-pnO8990J3u7kvyCSZ3nO6756x180qB7nDvcQ/formResponse', {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                });
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                successDiv.innerHTML = '<i class="fas fa-check-circle"></i> Lyrics published to user portal successfully!';
                
                const lyricsDisplay = document.getElementById('generated-lyrics-display');
                lyricsDisplay.appendChild(successDiv);
                
                // Clear the generated lyrics after publishing
                setTimeout(() => {
                    successDiv.remove();
                    document.getElementById('generated-lyrics-display').style.display = 'none';
                    generatedLyrics = '';
                    document.getElementById('generate-song-btn').disabled = true;
                    
                    // Refresh songs on user page if currently viewing it
                    if (document.getElementById('user-page').style.display !== 'none') {
                        loadSongs();
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error publishing lyrics:', error);
                alert('Error publishing lyrics. Please try again.');
            }
        }
    </script>
</body>
</html>
